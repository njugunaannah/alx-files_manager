# Tasks

## 0. Redis utils

**File:** `utils/redis.js`

- Inside the folder `utils`, create a file `redis.js` that contains the class `RedisClient`.
- `RedisClient` should have:
  - The constructor that creates a client to Redis:
    - Any error of the Redis client must be displayed in the console (you should use `on('error')` of the Redis client).
  - A function `isAlive` that returns `true` when the connection to Redis is a success; otherwise, `false`.
  - An asynchronous function `get` that takes a string `key` as an argument and returns the Redis value stored for this key.
  - An asynchronous function `set` that takes a string `key`, a `value`, and a `duration` in seconds as arguments to store it in Redis (with an expiration set by the duration argument).
  - An asynchronous function `del` that takes a string `key` as an argument and removes the value in Redis for this key.
- After the class definition, create and export an instance of `RedisClient` called `redisClient`.

## 1. MongoDB utils

**File:** `utils/db.js`

- Inside the folder `utils`, create a file `db.js` that contains the class `DBClient`.
- `DBClient` should have:
  - The constructor that creates a client to MongoDB:
    - `host`: from the environment variable `DB_HOST` or default: `localhost`.
    - `port`: from the environment variable `DB_PORT` or default: `27017`.
    - `database`: from the environment variable `DB_DATABASE` or default: `files_manager`.
  - A function `isAlive` that returns `true` when the connection to MongoDB is a success; otherwise, `false`.
  - An asynchronous function `nbUsers` that returns the number of documents in the collection `users`.
  - An asynchronous function `nbFiles` that returns the number of documents in the collection `files`.
- After the class definition, create and export an instance of `DBClient` called `dbClient`.

## 2. First API

**Files:** `server.js`, `routes/index.js`, `controllers/AppController.js`

- Inside `server.js`, create the Express server:
  - It should listen on the port set by the environment variable `PORT` or by default `5000`.
  - It should load all routes from the file `routes/index.js`.
- Inside the folder `routes`, create a file `index.js` that contains all endpoints of our API:
  - `GET /status` => `AppController.getStatus`.
  - `GET /stats` => `AppController.getStats`.
- Inside the folder `controllers`, create a file `AppController.js` that contains the definition of the 2 endpoints:
  - `GET /status` should return if Redis is alive and if the DB is alive too by using the 2 utils created previously: `{ "redis": true, "db": true }` with a status code `200`.
  - `GET /stats` should return the number of users and files in DB: `{ "users": 12, "files": 1231 }` with a status code `200`.

## 3. Create a new user

**Files:** `routes/index.js`, `controllers/UsersController.js`

- In the file `routes/index.js`, add a new endpoint:
  - `POST /users` => `UsersController.postNew`.
- Inside `controllers`, add a file `UsersController.js` that contains the new endpoint:
  - `POST /users` should create a new user in DB:
    - To create a user, you must specify an `email` and a `password`.
    - If the email is missing, return an error `Missing email` with a status code `400`.
    - If the password is missing, return an error `Missing password` with a status code `400`.
    - If the email already exists in DB, return an error `Already exist` with a status code `400`.
    - The password must be stored after being hashed in SHA1.
    - The endpoint is returning the new user with only the `email` and the `id` (auto-generated by MongoDB) with a status code `201`.

## 4. Authenticate a user

**Files:** `routes/index.js`, `controllers/UsersController.js`, `controllers/AuthController.js`

- In the file `routes/index.js`, add 3 new endpoints:
  - `GET /connect` => `AuthController.getConnect`.
  - `GET /disconnect` => `AuthController.getDisconnect`.
  - `GET /users/me` => `UserController.getMe`.
- Inside `controllers`, add a file `AuthController.js` that contains new endpoints:
  - `GET /connect` should sign in the user by generating a new authentication token.
  - `GET /disconnect` should sign out the user based on the token.
- Inside the file `controllers/UsersController.js` add a new endpoint:
  - `GET /users/me` should retrieve the user based on the token used.

## 5. First file

**Files:** `routes/index.js`, `controllers/FilesController.js`

- In the file `routes/index.js`, add a new endpoint:
  - `POST /files` => `FilesController.postUpload`.
- Inside `controllers`, add a file `FilesController.js` that contains the new endpoint:
  - `POST /files` should create a new file in DB and in disk.

## 6. Get and list file

**Files:** `routes/index.js`, `controllers/FilesController.js`

- In the file `routes/index.js`, add 2 new endpoints:
  - `GET /files/:id` => `FilesController.getShow`.
  - `GET /files` => `FilesController.getIndex`.
- In the file `controllers/FilesController.js`, add the 2 new endpoints:
  - `GET /files/:id` should retrieve the file document based on the ID.
  - `GET /files` should retrieve all users' file documents for a specific `parentId` and with pagination.

## 7. File publish/unpublish

**Files:** `routes/index.js`, `controllers/FilesController.js`

- In the file `routes/index.js`, add 2 new endpoints:
  - `PUT /files/:id/publish` => `FilesController.putPublish`.
  - `PUT /files/:id/unpublish` => `FilesController.putUnpublish`.
- In the file `controllers/FilesController.js`, add the 2 new endpoints:
  - `PUT /files/:id/publish` should set `isPublic` to `true` on the file document based on the ID.
  - `PUT /files/:id/unpublish` should set `isPublic` to `false` on the file document based on the ID.

## 8. File data

**Files:** `routes/index.js`, `controllers/FilesController.js`

- In the file `routes/index.js`, add one new endpoint:
  - `GET /files/:id/data` => `FilesController.getFile`.
- In the file `controllers/FilesController.js`, add the new endpoint:
  - `GET /files/:id/data` should return the content of the file document based on the ID.

## 9. Image Thumbnails

**Files:** `controllers/FilesController.js`, `worker.js`

- Update the endpoint `POST /files` endpoint to start a background processing for generating thumbnails for a file of type `image`.
- Create a file `worker.js`:
  - By using the module Bull, create a queue `fileQueue`.
  - Process this queue to generate thumbnails and store the results.

## 10. Tests!

**File:** `tests/`

- Create tests for `redisClient` and `dbClient`.
- Create tests for each endpoint:
  - `GET /status`
  - `GET /stats`
  - `POST /users`
  - `GET /connect`
  - `GET /disconnect`
  - `GET /users/me`
  - `POST /files`
  - `GET /files/:id`
  - `GET /files` (don't forget the pagination)
  - `PUT /files/:id/publish`
  - `PUT /files/:id/unpublish`
  - `GET /files/:id/data`

## 11. New user - welcome email

**Files:** `worker.js`, `controllers/UsersController.js`

- Update the endpoint `POST /users` endpoint to start a background processing for sending a "Welcome email" to the user.
- Update the file `worker.js`:
  - By using the module Bull, create a queue `userQueue`.
  - Process this queue to print a welcome message in the console.
